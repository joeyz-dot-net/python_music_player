<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ğŸµç‚¹æ­Œå°</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link rel="stylesheet" href="static/style.css">
</head>
<body>
  <h1>ğŸ¶ ç‚¹æ­Œå°</h1>
  <div class="volume-bar">
    <label for="volume">ğŸ”Š éŸ³é‡ï¼š</label>
    <input type="range" id="volume" min="0" max="100" value="80" oninput="setVolume(this.value)">
  </div>

  {% macro render_node(node, root=False) %}
  {% if root %}
  <div class="root-node">
    <div class="flex-row-wrap">
      {% for file in node.files %}
        
        <div class="song-card track{% if file.abs == current_file %} playing{% endif %}" onclick="play('{{ file.rel }}')">
          {{ song_title }}
          <div class="song-info">{{ song_title }}</div>
        </div>
      {% endfor %}
    </div>
    <div class="dir-grid">
      {% for dir in node.dirs %}
      <div class="dir-item">
       
        <img class="album-cover large" src="{{ artist_photo }}" data-artist="{{ dir.name }}" data-default="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4bf.png" alt="{{ dir.name }}">
        <span class="dir-name">{{ dir.name }}</span>
        <div class="dir-files">
          <div class="flex-row-wrap">
            {% for file in dir.files %}
              {% set song_title = file.name.rsplit('.',1)[0][:18] %}
              <div class="song-card track{% if file.abs == current_file %} playing{% endif %}" onclick="play('{{ file.rel }}')">
                <img class="album-cover small" src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4bf.png" data-artist="{{ dir.name }}" data-track="{{ song_title }}" data-default="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4bf.png" alt="{{ song_title }}">
                <div class="song-info">{{ song_title }}<small>{{ dir.name }}</small></div>
              </div>
            {% endfor %}
          </div>
          {% for sub in dir.dirs %}
            {{ render_node(sub) }}
          {% endfor %}
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% else %}
  <details>
    <summary>
     
      <img class="album-cover large" src="{{ artist_photo }}" data-artist="{{ node.name }}" data-default="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4bf.png" alt="{{ node.name }}">
      <span class="dir-name">{{ node.name }}</span>
    </summary>
    <div class="dir-files">
      <div class="flex-row-wrap">
        {% for file in node.files %}
          {% set song_title = file.name.rsplit('.',1)[0][:18] %}
          <div class="song-card track{% if file.abs == current_file %} playing{% endif %}" onclick="play('{{ file.rel }}')">
            <img class="album-cover small" src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4bf.png" data-artist="{{ node.name }}" data-track="{{ song_title }}" data-default="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4bf.png" alt="{{ song_title }}">
            <div class="song-info">{{ song_title }}<small>{{ node.name }}</small></div>
          </div>
        {% endfor %}
      </div>
      {% for d in node.dirs %}
        {{ render_node(d) }}
      {% endfor %}
    </div>
  </details>
  {% endif %}
  {% endmacro %}

  {{ render_node(tree, True) }}

<script src="static/main.js"></script>
</body>
</html>
<script>
function play(rel) {
  const now = Date.now();
  if (now - lastPlayTime < 3000) return; // 3ç§’å†…åªå…è®¸ä¸€æ¬¡æ’­æ”¾
  lastPlayTime = now;

  // ç§»é™¤æ‰€æœ‰é«˜äº®
  document.querySelectorAll(".track").forEach(div => {
    div.classList.remove("playing");
  });

  // æ·»åŠ é«˜äº®åˆ°å½“å‰æ’­æ”¾é¡¹
  const current = document.querySelector(`.track[onclick*="'${rel}'"]`);
  if (current) current.classList.add("playing");

  fetch("/play", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: "path=" + encodeURIComponent(rel)
  })
  .then(res => res.text())
  .then(data => {
    // ä¸å† reloadï¼Œç›´æ¥é«˜äº®
    // location.reload();
  });
}

    let lastVolumeSetTime = 0;
    function setVolume(val) {
      const now = Date.now();
      if (now - lastVolumeSetTime < 1000) return; // 1ç§’å†…åªå…è®¸ä¸€æ¬¡
      lastVolumeSetTime = now;
      fetch("/volume", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "level=" + val
      });
    }

document.addEventListener("DOMContentLoaded", function() {
  // è‡ªåŠ¨è·å–ç½‘ç»œæ­Œæ‰‹å¤´åƒå’Œä¸“è¾‘å°é¢
  const artistPhotoCache = {};
  document.querySelectorAll("img.album-cover").forEach(function(img) {
    const artist = img.getAttribute("data-artist");
    const track = img.getAttribute("data-track");
    const defaultUrl = img.getAttribute("data-default");
    if (!artist) return;
    // å…ˆå°è¯•æœ¬åœ°å›¾ç‰‡ï¼Œå¤±è´¥åè‡ªåŠ¨è·å–ç½‘ç»œå¤´åƒ
    img.onerror = function() {
      // æ­Œæ‰‹å¤´åƒä¼˜å…ˆ
      fetch("/artist_image/" + encodeURIComponent(artist))
        .then(res => res.json())
        .then(data => {
          if (data.url) {
            img.src = data.url;
            img.style.display = "inline-block";
            artistPhotoCache[artist] = data.url;
          } else {
            img.src = defaultUrl;
            img.style.display = "inline-block";
          }
        })
        .catch(() => {
          img.src = defaultUrl;
          img.style.display = "inline-block";
        });
    };
    // å¦‚æœæœ‰trackï¼Œå°è¯•è·å–ä¸“è¾‘å°é¢
    if (track) {
      fetch("/album_cover/" + encodeURIComponent(artist) + "/" + encodeURIComponent(track))
        .then(res => res.json())
        .then(data => {
          if (data.url) {
            img.src = data.url;
            img.style.display = "inline-block";
          }
        });
    }
  });

  // ç›®å½•å¡ç‰‡ç‚¹å‡»å±•å¼€/æ”¶èµ·
  document.querySelectorAll('.dir-item').forEach(function(item) {
    item.addEventListener('click', function(e) {
      // é¿å…ç‚¹å‡»æ­Œæ›²æ—¶è§¦å‘ç›®å½•å±•å¼€
      if (e.target.closest('.track')) return;
      // åªå±•å¼€å½“å‰ï¼Œæ”¶èµ·å…¶ä»–
      document.querySelectorAll('.dir-item.active').forEach(function(active) {
        if (active !== item) active.classList.remove('active');
      });
      item.classList.toggle('active');
    });
  });
});
  </script>
</body>
</html>
